<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中药溯源查询</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --line: #e6ebf2;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #1d4ed8;
      --danger: #b42318;
      --ok: #15803d;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      width: min(1100px, 100%);
      margin: 0 auto;
      padding: 20px 14px 28px;
    }

    .header {
      background: linear-gradient(180deg, #eef4ff 0%, #f8fbff 100%);
      border: 1px solid #dbe6ff;
      border-radius: 14px;
      padding: 16px;
    }

    .title {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .subtitle {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .search {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 10px;
    }

    @media (max-width: 640px) {
      .search { grid-template-columns: 1fr; }
    }

    .input {
      width: 100%;
      height: 44px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 0 12px;
      font-size: 15px;
      background: #fff;
    }

    .btn {
      height: 44px;
      border: 1px solid #1546c7;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      font-size: 15px;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .tip {
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }

    .tip.ok { color: var(--ok); }
    .tip.error { color: var(--danger); }

    .card {
      margin-top: 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }

    .card-title {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 700;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 760px) {
      .grid { grid-template-columns: 1fr; }
    }

    .kv {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fbfdff;
    }

    .kv-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .kv-value {
      font-size: 13px;
      word-break: break-all;
      white-space: pre-wrap;
    }

    .list {
      display: grid;
      gap: 8px;
    }

    .item {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }

    .item-title {
      margin: 0;
      font-size: 14px;
      font-weight: 650;
      line-height: 1.5;
    }

    .item-sub {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .empty {
      border: 1px dashed var(--line);
      border-radius: 10px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
      background: #fafcff;
    }

    details {
      margin-top: 10px;
    }

    .raw {
      width: 100%;
      min-height: 180px;
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      line-height: 1.5;
      background: #fbfdff;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">中药溯源查询</h1>
      <p class="subtitle">扫码后会自动打开本页并展示该批次的全链路溯源信息。</p>
      <div class="search">
        <input id="batchInput" class="input" placeholder="请输入或扫码带入批次号，例如：MOCK-2024001-P" />
        <button id="queryBtn" class="btn" type="button">查询溯源</button>
      </div>
      <div id="tip" class="tip">等待查询</div>
    </div>

    <div class="card">
      <h2 class="card-title">批次基本信息</h2>
      <div id="batchGrid" class="grid"></div>
    </div>

    <div class="card">
      <h2 class="card-title">批次谱系（根批次到当前批次）</h2>
      <div id="lineageList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="card-title">种植记录</h2>
      <div id="plantingList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="card-title">加工记录</h2>
      <div id="processingList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="card-title">质检记录</h2>
      <div id="inspectionList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="card-title">物流记录</h2>
      <div id="logisticsList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="card-title">发运单及轨迹事件</h2>
      <div id="shipmentsList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="card-title">区块链存证</h2>
      <div id="blockchainGrid" class="grid"></div>
      <div id="txLinkWrap" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2 class="card-title">原始数据</h2>
      <details>
        <summary>展开 JSON</summary>
        <textarea id="rawJson" class="raw" readonly></textarea>
      </details>
    </div>
  </div>

  <script>
    function byId(id) { return document.getElementById(id); }

    function text(v) {
      if (v === null || v === undefined || v === '') return '-';
      return String(v);
    }

    function formatTime(v) {
      if (!v) return '-';
      return String(v).replace('T', ' ');
    }

    function parseBatchNoFromLocation() {
      const params = new URLSearchParams(window.location.search);
      const direct = params.get('batchNo') || params.get('batch') || params.get('code');
      if (direct) return direct.trim();

      if (window.location.hash) {
        const hash = window.location.hash.replace(/^#/, '');
        const hashParams = new URLSearchParams(hash);
        const hashNo = hashParams.get('batchNo') || hashParams.get('batch') || hashParams.get('code');
        if (hashNo) return hashNo.trim();
      }

      return '';
    }

    function setTip(msg, type) {
      const el = byId('tip');
      el.textContent = msg;
      el.className = 'tip' + (type ? (' ' + type) : '');
    }

    function clearNode(node) {
      while (node.firstChild) node.removeChild(node.firstChild);
    }

    function appendEmpty(node, msg) {
      const d = document.createElement('div');
      d.className = 'empty';
      d.textContent = msg;
      node.appendChild(d);
    }

    function appendKv(node, label, value) {
      const box = document.createElement('div');
      box.className = 'kv';

      const k = document.createElement('div');
      k.className = 'kv-label';
      k.textContent = label;

      const v = document.createElement('div');
      v.className = 'kv-value';
      v.textContent = text(value);

      box.appendChild(k);
      box.appendChild(v);
      node.appendChild(box);
    }

    function appendItem(node, title, lines) {
      const item = document.createElement('div');
      item.className = 'item';

      const t = document.createElement('p');
      t.className = 'item-title';
      t.textContent = text(title);

      const s = document.createElement('p');
      s.className = 'item-sub';
      s.textContent = (lines || []).filter(Boolean).join('\n') || '-';

      item.appendChild(t);
      item.appendChild(s);
      node.appendChild(item);
    }

    async function fetchTrace(batchNo) {
      const res = await fetch('/api/v1/trace/' + encodeURIComponent(batchNo));
      const payload = await res.json().catch(() => null);

      if (!res.ok) {
        const msg = payload && payload.message ? payload.message : ('HTTP ' + res.status);
        throw new Error(msg);
      }
      if (!payload || payload.code !== 200) {
        throw new Error((payload && payload.message) || '查询失败');
      }
      return payload.data || {};
    }

    function render(data) {
      const batchGrid = byId('batchGrid');
      const lineageList = byId('lineageList');
      const plantingList = byId('plantingList');
      const processingList = byId('processingList');
      const inspectionList = byId('inspectionList');
      const logisticsList = byId('logisticsList');
      const shipmentsList = byId('shipmentsList');
      const blockchainGrid = byId('blockchainGrid');
      const txLinkWrap = byId('txLinkWrap');

      [batchGrid, lineageList, plantingList, processingList, inspectionList, logisticsList, shipmentsList, blockchainGrid, txLinkWrap].forEach(clearNode);

      const b = data.batch || {};
      appendKv(batchGrid, '批次号', b.batchNo);
      appendKv(batchGrid, '药材名称', b.name);
      appendKv(batchGrid, '类别', b.category);
      appendKv(batchGrid, '产地', b.origin);
      appendKv(batchGrid, '状态', b.status);
      appendKv(batchGrid, '数量', (b.quantity || b.quantity === 0) ? (b.quantity + ' ' + text(b.unit)) : '-');
      appendKv(batchGrid, '隐形防伪码', b.minCode);
      appendKv(batchGrid, 'GS1 批号', b.gs1LotNo);
      appendKv(batchGrid, 'GS1 码', b.gs1Code);
      appendKv(batchGrid, '创建时间', formatTime(b.createdAt));

      const lineageBatches = Array.isArray(data.lineageBatches) ? data.lineageBatches : [];
      if (lineageBatches.length === 0) {
        appendEmpty(lineageList, '无谱系数据');
      } else {
        lineageBatches.forEach((node, idx) => {
          const lines = [
            '名称：' + text(node.name),
            '状态：' + text(node.status),
            '产地：' + text(node.origin),
            '批次：' + text(node.batchNo)
          ];
          appendItem(lineageList, (idx === 0 ? '根批次' : '链路节点 ' + idx), lines);
        });
      }

      const planting = Array.isArray(data.plantingRecords) ? data.plantingRecords : [];
      if (planting.length === 0) {
        appendEmpty(plantingList, '无种植记录');
      } else {
        planting.forEach((r) => {
          appendItem(plantingList, text(r.operation) + ' | ' + formatTime(r.operationTime), [
            '地块：' + text(r.fieldName),
            '操作人：' + text(r.operator),
            '详情：' + text(r.details),
            '定位：' + (r.latitude && r.longitude ? (r.latitude + ', ' + r.longitude) : '-')
          ]);
        });
      }

      const processing = Array.isArray(data.processingRecords) ? data.processingRecords : [];
      if (processing.length === 0) {
        appendEmpty(processingList, '无加工记录');
      } else {
        processing.forEach((r) => {
          appendItem(processingList, text(r.processType) + ' | ' + text(r.batchNo), [
            '上游批次：' + text(r.parentBatchNo),
            '产线：' + text(r.lineName),
            '工厂：' + text(r.factory),
            '操作人：' + text(r.operator),
            '详情：' + text(r.details),
            '创建时间：' + formatTime(r.createdAt)
          ]);
        });
      }

      const inspection = Array.isArray(data.inspectionRecords) ? data.inspectionRecords : [];
      if (inspection.length === 0) {
        appendEmpty(inspectionList, '无质检记录');
      } else {
        inspection.forEach((r) => {
          appendItem(inspectionList, text(r.result) + ' | ' + text(r.batchNo), [
            '质检员：' + text(r.inspector),
            '报告链接：' + text(r.reportUrl),
            '创建时间：' + formatTime(r.createdAt)
          ]);
        });
      }

      const logistics = Array.isArray(data.logisticsRecords) ? data.logisticsRecords : [];
      if (logistics.length === 0) {
        appendEmpty(logisticsList, '无物流记录');
      } else {
        logistics.forEach((r) => {
          appendItem(logisticsList, text(r.status) + ' | ' + formatTime(r.updateTime), [
            '当前位置：' + text(r.location),
            '起点：' + text(r.fromLocation),
            '终点：' + text(r.toLocation),
            '物流单号：' + text(r.trackingNo)
          ]);
        });
      }

      const shipments = Array.isArray(data.shipmentsWithEvents) ? data.shipmentsWithEvents : [];
      if (shipments.length === 0) {
        appendEmpty(shipmentsList, '无发运单记录');
      } else {
        shipments.forEach((s) => {
          const shipment = s.shipment || {};
          const events = Array.isArray(s.events) ? s.events : [];

          const lines = [
            '发运单号：' + text(shipment.shipmentNo),
            '收货方：' + text(shipment.distributorName),
            '承运商：' + text(shipment.carrier),
            '运单号：' + text(shipment.trackingNo),
            '状态：' + text(shipment.status),
            '备注：' + text(shipment.remarks),
            '创建时间：' + formatTime(shipment.createdAt)
          ];

          if (events.length === 0) {
            lines.push('轨迹事件：无');
          } else {
            const eventLines = events.map((e, idx) => {
              return (idx + 1) + '. ' + formatTime(e.eventTime) + ' | ' + text(e.location) + ' | ' + text(e.status) + (e.details ? (' | ' + e.details) : '');
            });
            lines.push('轨迹事件：');
            lines.push(eventLines.join('\n'));
          }

          appendItem(shipmentsList, '发运单', lines);
        });
      }

      const bc = data.blockchainRecord || {};
      appendKv(blockchainGrid, '存证状态', bc.txHash ? '已存证' : '未存证');
      appendKv(blockchainGrid, '网络模式', bc.mode);
      appendKv(blockchainGrid, '交易哈希', bc.txHash);
      appendKv(blockchainGrid, '上链时间', formatTime(bc.createdAt));

      if (bc.txUrl) {
        const link = document.createElement('a');
        link.href = bc.txUrl;
        link.target = '_blank';
        link.rel = 'noreferrer';
        link.textContent = '查看区块链浏览器详情';
        txLinkWrap.appendChild(link);
      }

      byId('rawJson').value = JSON.stringify(data, null, 2);
    }

    async function query() {
      const batchNo = byId('batchInput').value.trim();
      if (!batchNo) {
        setTip('请先输入批次号', 'error');
        return;
      }

      const btn = byId('queryBtn');
      btn.disabled = true;
      setTip('正在查询...', '');

      try {
        const data = await fetchTrace(batchNo);
        render(data);
        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set('batchNo', batchNo);
        window.history.replaceState({}, '', nextUrl.toString());
        setTip('查询成功：' + batchNo, 'ok');
      } catch (err) {
        setTip('查询失败：' + (err && err.message ? err.message : '未知错误'), 'error');
      } finally {
        btn.disabled = false;
      }
    }

    byId('queryBtn').addEventListener('click', query);
    byId('batchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') query();
    });

    const initialBatchNo = parseBatchNoFromLocation();
    if (initialBatchNo) {
      byId('batchInput').value = initialBatchNo;
      query();
    }
  </script>
</body>
</html>
