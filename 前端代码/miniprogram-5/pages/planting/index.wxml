<view class="page-container">
    <view class="header">
        <view class="title">种植录入</view>
        <view class="desc">录入药材在田间的日常操作与生长情况</view>
    </view>

    <view class="card">
        <view class="section-title">当前批次</view>
        <picker mode="selector" range="{{batches}}" range-key="batchNo" value="{{batchIndex}}" bindchange="onBatchChange">
            <view class="picker-row">
                <view class="picker-label">批次号</view>
                <view class="picker-value">{{currentBatch ? currentBatch.batchNo : '暂无批次（请先创建批次）'}}</view>
            </view>
        </picker>
        <view class="batch-meta" wx:if="{{currentBatch}}">
            <view class="batch-line">名称：{{currentBatch.name || '-'}}</view>
            <view class="batch-line">产地：{{currentBatch.origin || '-'}}</view>
            <view class="batch-line">状态：{{currentBatch.status || '-'}}</view>
            <view class="batch-line" wx:if="{{currentBatch.gs1Code}}">GS1：{{currentBatch.gs1Code}}</view>
        </view>
    </view>

    <view class="card">
        <view class="section-title">记录列表</view>
        <view class="stat-row">
            <view class="stat-item">
                <view class="stat-value">{{records.length}}</view>
                <view class="stat-label">已录入条数</view>
            </view>
            <view class="stat-item">
                <view class="stat-value">{{loading ? '加载中' : '就绪'}}</view>
                <view class="stat-label">接口状态</view>
            </view>
        </view>
        <view class="meta" wx:if="{{lastUpdatedAt}}">
            最近刷新: {{lastUpdatedAt}}
        </view>
        <view class="btn-group">
            <button class="btn btn-primary" bindtap="startCreate">新建记录</button>
            <button class="btn btn-outline" bindtap="refresh">重新拉取</button>
        </view>
        <view class="empty" wx:if="{{!loading && records.length === 0}}">
            暂无数据，可以点击“新建记录”开始录入。
        </view>
        <view class="list" wx:if="{{records.length > 0}}">
            <view class="list-item" wx:for="{{records}}" wx:key="id" bindtap="editFromList" data-id="{{item.id}}">
                <view class="list-main">
                    <view class="list-title">
                        #{{item.id}} · {{item.operation || '未填写操作'}}
                    </view>
                    <view class="list-sub">
                        批次: {{item.batchNo || '-'}} · 地块: {{item.fieldName || '-'}} · 操作人: {{item.operator || '-'}}
                    </view>
                    <view class="list-meta" wx:if="{{item.createdAtText}}">
                        创建: {{item.createdAtText}}
                    </view>
                </view>
                <view class="list-action">编辑</view>
            </view>
        </view>
    </view>

    <view class="card" wx:if="{{showForm}}">
        <view class="section-title">新建/编辑</view>
        <view class="readonly-row" wx:if="{{form.id}}">
            <view class="readonly-label">记录ID</view>
            <view class="readonly-value">#{{form.id}}</view>
        </view>
        <view class="readonly-row">
            <view class="readonly-label">批次号</view>
            <view class="readonly-value">{{form.batchNo}}</view>
        </view>
        <view class="field-label">地块名称</view>
        <input class="input" placeholder="例如：一号地块" value="{{form.fieldName}}" data-field="fieldName" bindinput="onInput" />
        <view class="sub-title">操作类型</view>
        <view class="chip-row">
            <view class="chip {{selectedOperation === item ? 'chip-active' : ''}}" wx:for="{{operationOptions}}" wx:key="*this" data-value="{{item}}" bindtap="selectOperation">
                {{item}}
            </view>
        </view>
        <view wx:if="{{selectedOperation === '其他'}}">
            <view class="field-label">自定义操作类型</view>
            <input class="input" placeholder="例如：病虫害排查" value="{{customOperation}}" bindinput="onCustomOperationInput" />
        </view>
        <view class="field-label">操作人（可改）</view>
        <input class="input" placeholder="例如：张三" value="{{form.operator}}" data-field="operator" bindinput="onInput" />
        <view class="field-label">详细描述</view>
        <textarea class="textarea" placeholder="可选：用量、天气、备注等" value="{{form.details}}" data-field="details" bindinput="onInput" />
        <button class="btn btn-outline" bindtap="toggleOptional">更多选项（附件）</button>
        <view wx:if="{{showOptional}}" style="margin-top:20rpx">
            <view class="field-label">图片链接（可选）</view>
            <input class="input" placeholder="https://..." value="{{form.imageUrl}}" data-field="imageUrl" bindinput="onInput" />
            <view class="field-label">语音链接（可选）</view>
            <input class="input" placeholder="https://..." value="{{form.audioUrl}}" data-field="audioUrl" bindinput="onInput" />
        </view>
        <view class="btn-group">
            <button class="btn btn-primary" bindtap="save">保存</button>
            <button class="btn btn-warn" wx:if="{{form.id}}" bindtap="remove">删除</button>
        </view>
        <button class="btn btn-outline" style="margin-top:20rpx" bindtap="cancelEdit">收起</button>
    </view>
</view>
