<view class="page-container">
    <view class="header">
        <view class="title">种植录入</view>
        <view class="desc">录入药材在田间的日常操作与生长情况</view>
    </view>

    <view class="card">
        <view class="section-title">当前批次</view>
        <picker mode="selector" range="{{batches}}" range-key="batchNo" value="{{batchIndex}}" bindchange="onBatchChange">
            <view class="picker-row">
                <view class="picker-label">批次号</view>
                <view class="picker-value">{{currentBatch ? currentBatch.batchNo : '暂无批次（请先创建批次）'}}</view>
            </view>
        </picker>
        <view class="batch-meta" wx:if="{{currentBatch}}">
            <view class="batch-line">名称：{{currentBatch.name || '-'}}</view>
            <view class="batch-line">产地：{{currentBatch.origin || '-'}}</view>
            <view class="batch-line">状态：{{currentBatch.status || '-'}}</view>
            <view class="batch-line" wx:if="{{currentBatch.gs1Code}}">GS1：{{currentBatch.gs1Code}}</view>
        </view>
    </view>

    <view class="card">
        <view class="section-title">记录列表</view>
        <view class="search-bar">
            <input class="input-inline" placeholder="输入ID/地块/操作/操作人查询" value="{{queryKey}}" bindinput="onQueryInput" />
            <button class="btn-small" bindtap="query">查询</button>
        </view>
        <view class="btn-group">
            <button class="btn btn-primary" bindtap="startCreate">新建记录</button>
            <button class="btn btn-outline" bindtap="refresh">刷新列表</button>
        </view>
        <view class="meta" wx:if="{{lastUpdatedAt}}">
            最近刷新: {{lastUpdatedAt}}
        </view>
        <view class="empty" wx:if="{{!loading && records.length === 0}}">
            暂无数据，可以点击“新建记录”开始录入。
        </view>
        <view class="list" wx:if="{{records.length > 0}}">
            <view class="list-item" wx:for="{{records}}" wx:key="id" bindtap="editFromList" data-id="{{item.id}}">
                <view class="list-main">
                    <view class="list-title">
                        #{{item.id}} · {{item.operation || '未填写操作'}}
                    </view>
                    <view class="list-sub">
                        批次: {{item.batchNo || '-'}} · 地块: {{item.fieldName || '-'}} · 操作人: {{item.operator || '-'}}
                    </view>
                    <view class="list-meta" wx:if="{{item.createdAtText}}">
                        创建: {{item.createdAtText}}
                    </view>
                </view>
                <view class="list-action">编辑</view>
            </view>
        </view>
    </view>

    <view class="card" wx:if="{{showForm}}">
        <view class="section-title">新建/编辑</view>
        <view class="readonly-row" wx:if="{{form.id}}">
            <view class="readonly-label">记录ID</view>
            <view class="readonly-value">#{{form.id}}</view>
        </view>
        <view class="readonly-row">
            <view class="readonly-label">批次号</view>
            <view class="readonly-value">{{form.batchNo}}</view>
        </view>
        <view class="field-label">地块名称</view>
        <input class="input" placeholder="例如：一号地块" value="{{form.fieldName}}" data-field="fieldName" bindinput="onInput" />
        <view class="sub-title">操作类型</view>
        <view class="chip-row">
            <view class="chip {{selectedOperation === item ? 'chip-active' : ''}}" wx:for="{{operationOptions}}" wx:key="*this" data-value="{{item}}" bindtap="selectOperation">
                {{item}}
            </view>
        </view>
        <view wx:if="{{selectedOperation === '其他'}}">
            <view class="field-label">自定义操作类型</view>
            <input class="input" placeholder="例如：病虫害排查" value="{{customOperation}}" bindinput="onCustomOperationInput" />
        </view>
        <view class="field-label">操作人（可改）</view>
        <input class="input" placeholder="例如：张三" value="{{form.operator}}" data-field="operator" bindinput="onInput" />
        <view class="field-label">详细描述</view>
        <textarea class="textarea" placeholder="可选：用量、天气、备注等" value="{{form.details}}" data-field="details" bindinput="onInput" />
        <button class="btn btn-outline" bindtap="toggleOptional">更多选项（附件）</button>
        <view wx:if="{{showOptional}}" style="margin-top:20rpx">
            <view class="field-label">定位（关键操作必填）</view>
            <view class="meta" wx:if="{{form.latitude && form.longitude}}">
                已获取：{{form.latitude}}, {{form.longitude}}
            </view>
            <view class="field-label">图片（可选）</view>
            <view class="btn-group">
                <button class="btn btn-outline" bindtap="chooseImage">选择图片</button>
                <button class="btn btn-outline" wx:if="{{imageFilePath || form.imageUrl}}" bindtap="previewImage">预览</button>
                <button class="btn btn-warn" wx:if="{{imageFilePath || form.imageUrl}}" bindtap="clearImage">清除</button>
            </view>
            <view class="meta" wx:if="{{imageFilePath}}">已选择：本地图片</view>
            <view class="meta" wx:if="{{!imageFilePath && form.imageUrl}}">已保存：{{form.imageUrl}}</view>

            <view class="field-label" style="margin-top:20rpx;">语音（可选）</view>
            <view class="btn-group">
                <button class="btn btn-outline" bindtap="chooseAudio">选择音频</button>
                <button class="btn btn-outline" wx:if="{{!recording}}" bindtap="startRecord">开始录音</button>
                <button class="btn btn-warn" wx:if="{{recording}}" bindtap="stopRecord">停止录音</button>
                <button class="btn btn-warn" wx:if="{{audioFilePath || form.audioUrl}}" bindtap="clearAudio">清除</button>
            </view>
            <view class="meta" wx:if="{{recording}}">录音中...</view>
            <view class="meta" wx:if="{{audioFilePath}}">已录音：本地音频</view>
            <view class="meta" wx:if="{{!audioFilePath && form.audioUrl}}">已保存：{{form.audioUrl}}</view>

            <view class="meta" wx:if="{{uploading}}" style="color:#999;">附件上传中...</view>
        </view>
        <view class="btn-group">
            <button class="btn btn-primary" bindtap="save">保存</button>
            <button class="btn btn-warn" wx:if="{{form.id}}" bindtap="remove">删除</button>
        </view>
        <button class="btn btn-outline" style="margin-top:20rpx" bindtap="cancelEdit">收起</button>
    </view>
</view>
