<view class="page-container">
    <view class="header">
        <view class="title">{{form.id ? '编辑种植记录' : '新建种植记录'}}</view>
        <view class="desc">关键操作会自动获取定位，且必须上传图片或语音留痕</view>
    </view>

    <view class="card">
        <view class="section-title">基本信息</view>
        <view class="readonly-row" wx:if="{{form.id}}">
            <view class="readonly-label">记录ID</view>
            <view class="readonly-value">#{{form.id}}</view>
        </view>
        <view class="readonly-row">
            <view class="readonly-label">操作时间</view>
            <view class="readonly-value">{{operationTimeText}}</view>
        </view>
        <view class="readonly-row">
            <view class="readonly-label">批次号</view>
            <view class="readonly-value">{{form.batchNo}}</view>
        </view>

        <view class="field-label">地块名称</view>
        <input class="input" placeholder="例如：一号地块" value="{{form.fieldName}}" data-field="fieldName" bindinput="onInput" />

        <view class="sub-title">操作类型</view>
        <view class="chip-row">
            <view class="chip {{selectedOperation === item ? 'chip-active' : ''}}" wx:for="{{operationOptions}}" wx:key="*this" data-value="{{item}}" bindtap="selectOperation">
                {{item}}
            </view>
        </view>
        <view wx:if="{{selectedOperation === '其他'}}">
            <view class="field-label">自定义操作类型</view>
            <input class="input" placeholder="例如：病虫害排查" value="{{customOperation}}" bindinput="onCustomOperationInput" />
        </view>

        <view class="field-label">操作人（可改）</view>
        <input class="input" placeholder="例如：张三" value="{{form.operator}}" data-field="operator" bindinput="onInput" />

        <view class="field-label">详细描述</view>
        <textarea class="textarea" placeholder="可选：用量、天气、备注等" value="{{form.details}}" data-field="details" bindinput="onInput" />
    </view>

    <view class="card">
        <view class="section-title">证据与定位</view>

        <view class="field-label">定位（关键操作必填）</view>
        <view class="meta" wx:if="{{form.latitude && form.longitude}}">
            已获取：{{form.latitude}}, {{form.longitude}}
        </view>
        <view class="meta" wx:if="{{!form.latitude || !form.longitude}}" style="margin-bottom: 20rpx;">
            定位会自动获取（如果失败请检查定位权限）
        </view>

        <view class="field-label">图片（可选）</view>
        <view class="btn-group">
            <button class="btn btn-outline" bindtap="chooseImage">选择图片</button>
            <button class="btn btn-outline" wx:if="{{imageFilePath || form.imageUrl}}" bindtap="previewImage">预览</button>
            <button class="btn btn-warn" wx:if="{{imageFilePath || form.imageUrl}}" bindtap="clearImage">清除</button>
        </view>
        <view class="meta" wx:if="{{imageFilePath}}">已选择：本地图片</view>
        <view class="meta" wx:if="{{!imageFilePath && form.imageUrl}}">已保存：{{form.imageUrl}}</view>

        <view class="field-label" style="margin-top:20rpx;">语音（可选）</view>
        <view class="btn-group">
            <button class="btn btn-outline" bindtap="chooseAudio">选择音频</button>
            <button class="btn btn-outline" wx:if="{{!recording}}" bindtap="startRecord">开始录音</button>
            <button class="btn btn-warn" wx:if="{{recording}}" bindtap="stopRecord">停止录音</button>
            <button class="btn btn-warn" wx:if="{{audioFilePath || form.audioUrl}}" bindtap="clearAudio">清除</button>
        </view>
        <view class="meta" wx:if="{{recording}}">录音中...</view>
        <view class="meta" wx:if="{{audioFilePath}}">已录音：本地音频</view>
        <view class="meta" wx:if="{{!audioFilePath && form.audioUrl}}">已保存：{{form.audioUrl}}</view>

        <view class="meta" wx:if="{{uploading}}" style="color:#999; margin-top: 10rpx;">附件上传中...</view>
    </view>

    <view class="card">
        <view class="section-title">操作</view>
        <view class="btn-group">
            <button class="btn btn-primary" bindtap="save">保存</button>
            <button class="btn btn-warn" wx:if="{{form.id}}" bindtap="remove">删除</button>
        </view>
        <button class="btn btn-outline" style="margin-top:20rpx" bindtap="cancel">返回</button>
    </view>
</view>
