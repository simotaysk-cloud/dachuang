# æ™ºæ±‡æœ¬è‰ - ä¸­è¯æå…¨è¿‡ç¨‹æº¯æºç®¡ç†ç³»ç»Ÿ

æœ¬é¡¹ç›®æ˜¯ä¸€æ¬¾åŸºäº **Spring Boot** åç«¯ä¸ **å¾®ä¿¡å°ç¨‹åº** å‰ç«¯çš„å·¥ä¸šçº§ä¸­è¯ææº¯æºç®¡ç†è§£å†³æ–¹æ¡ˆã€‚æ—¨åœ¨å®ç°ä»ç§æ¤ã€åŠ å·¥ã€è´¨æ£€åˆ°ç‰©æµçš„å…¨é“¾è·¯æ•°å­—åŒ–è¿½è¸ªï¼Œå¹¶å¯¹æ¥ **GS1-128 å›½é™…æ ‡å‡†** ç¼–ç ã€‚

## ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½

- **å¤šè§’è‰²æƒé™ç®¡ç†**ï¼šæ”¯æŒç®¡ç†å‘˜ (Admin)ã€å†œæˆ· (Farmer)ã€åŠ å·¥å‚ (Factory)ã€ç‰©æµ (Logistics) åŠç›‘ç®¡æ–¹ (Regulator) çš„åˆ†æƒç®¡ç†ã€‚
- **å…¨æµç¨‹å­˜è¯**ï¼šæ¶µç›–ç§æ¤ã€åŠ å·¥ã€è´¨æ£€ã€ç‰©æµç­‰ç¯èŠ‚çš„è¯¦ç»†è®°å½•å½•å…¥ä¸å±•ç¤ºã€‚
- **GS1-128 å›½é™…æ ‡å‡†**ï¼š
    - è‡ªåŠ¨ç”Ÿæˆåˆè§„çš„ GS1-128 HRI ç¼–ç ã€‚
    - æ”¯æŒ `g/t/æ–¤` åˆ° `kg` çš„è‡ªåŠ¨å•ä½æ¢ç®—ã€‚
    - å…·å¤‡ GS1 é”å®šæœºåˆ¶ï¼Œç¡®ä¿æ‰“å°è´´æ ‡ååº“å­˜æ•°æ®çš„ä¸€è‡´æ€§ã€‚
- **åŒºå—é“¾å¯¹æ¥å‡†å¤‡**ï¼šå†…ç½®åŒºå—é“¾å­˜è¯é€»è¾‘æ¥å£ï¼Œæ”¯æŒæº¯æºæ•°æ®ä¸Šé“¾éªŒè¯ã€‚
- **å“åº”å¼ UI**ï¼šé‡‡ç”¨ç»Ÿä¸€çš„â€œåˆ—è¡¨+å¡ç‰‡â€è®¾è®¡è¯­è¨€ï¼Œæ“ä½œä½“éªŒæµç•…ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **åç«¯**ï¼šSpring Boot 3.2.2, Spring Data JPA, JWT (èº«ä»½è®¤è¯), MySQL 8.0+
- **å‰ç«¯**ï¼šå¾®ä¿¡å°ç¨‹åº (Vanilla WXML/WXSS/JS)
- **å·¥å…·**ï¼šMaven, å¾®ä¿¡å¼€å‘è€…å·¥å…·

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åç«¯éƒ¨ç½² (Spring Boot)

1. **ç¯å¢ƒå‡†å¤‡**ï¼šç¡®è®¤å·²å®‰è£… Java 17+ å’Œ MySQL 8.0+ã€‚
2. **åˆ›å»ºæ•°æ®åº“**ï¼š
   ```sql
   CREATE DATABASE dachuang CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```
   æˆ–ä½¿ç”¨æ¼”ç¤ºç¯å¢ƒä¸€é”®é‡å»ºè„šæœ¬ï¼ˆä¼š DROP å¹¶é‡å»ºæ•°æ®åº“ï¼›é€‚ç”¨äºæ¼”ç¤ºæ•°æ®ç¯å¢ƒï¼‰ï¼š
   ```bash
   cd åç«¯ä»£ç /springboot
   bash scripts/reset_demo_db.sh
   ```
   > å¦‚æœä½ ä¹‹å‰ä½¿ç”¨è¿‡æ—§ç‰ˆæœ¬ï¼ˆJPA è‡ªåŠ¨å»ºè¡¨ï¼‰ç”Ÿæˆè¿‡è¡¨ç»“æ„ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨ä¸Šè¿°è„šæœ¬é‡å»ºåº“ï¼Œé¿å… Flyway ä¸æ—§è¡¨ç»“æ„å†²çªã€‚
3. **é…ç½®ä¿®æ”¹**ï¼šä¿®æ”¹ `åç«¯ä»£ç /springboot/src/main/resources/application-dev.yml` ä¸­çš„æ•°æ®åº“è´¦å·å¯†ç ï¼š
   - é»˜è®¤è´¦å·: `dachuang`
   - é»˜è®¤å¯†ç : `Dachuang123!` (è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´)
   > è¯´æ˜ï¼šå½“å‰æ•°æ®åº“è¡¨ç»“æ„ç”± **Flyway** ç®¡ç†ï¼Œåç«¯å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»ï¼›JPA ä»…åš `validate` æ ¡éªŒã€‚
4. **è¿è¡ŒæœåŠ¡**ï¼š
   ```bash
   cd åç«¯ä»£ç /springboot
   mvn spring-boot:run -DskipTests
   ```
   æœåŠ¡é»˜è®¤è¿è¡Œåœ¨ `http://127.0.0.1:8081`ã€‚

### 2. å‰ç«¯éƒ¨ç½² (å¾®ä¿¡å°ç¨‹åº)

1. **å¯¼å…¥é¡¹ç›®**ï¼šä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·æ‰“å¼€ `å‰ç«¯ä»£ç /miniprogram-5` æ–‡ä»¶å¤¹ã€‚
2. **ä¿®æ”¹é…ç½®**ï¼š
   - æ‰“å¼€ `å‰ç«¯ä»£ç /miniprogram-5/utils/api.js`ï¼Œç¡®è®¤ `DEFAULT_BASE_URL` æŒ‡å‘æ‚¨çš„åç«¯åœ°å€ï¼ˆé»˜è®¤ä¸º `http://127.0.0.1:8081`ï¼‰ã€‚
   - åœ¨å¼€å‘è€…å·¥å…·ä¸­å‹¾é€‰â€œè¯¦æƒ… -> æœ¬åœ°è®¾ç½® -> ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewï¼ˆä¸šåŠ¡åŸŸåï¼‰ã€TLSç‰ˆæœ¬ä»¥åŠHTTPSè¯ä¹¦â€ã€‚
3. **è¿è¡Œé¢„è§ˆ**ï¼šç‚¹å‡»â€œç¼–è¯‘â€å³å¯æŸ¥çœ‹æ•ˆæœã€‚

## ğŸ”‘ é»˜è®¤è´¦å·

ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä»¥ä¸‹æµ‹è¯•è´¦å·ï¼š
- **ç®¡ç†å‘˜**ï¼š`admin` / `123456`
- **å†œæˆ·**ï¼š`farmer` / `123456`

## ğŸ§ª æ¼”ç¤ºæ•°æ®

ç³»ç»Ÿå†…ç½®äº†ä¸€å¥—å®Œæ•´çš„â€œé•¿ç™½å±±äººå‚â€æ¼”ç¤ºé“¾è·¯ï¼š
- æœç´¢æ‰¹æ¬¡å· `MOCK-2024001` å³å¯æŸ¥çœ‹å®Œæ•´çš„æº¯æºé—­ç¯ã€‚

## â›“ï¸ åŒºå—é“¾å­˜è¯ï¼ˆçœŸå®ä¸Šé“¾ï¼‰

é»˜è®¤æ˜¯æ¼”ç¤ºæ¨¡å¼ï¼ˆ`MOCK`ï¼‰ï¼Œä¼šç”Ÿæˆå‡çš„ `txHash`ã€‚å¦‚æœä½ è¦â€œçœŸçš„ä¸Šé“¾â€ï¼Œåç«¯å·²æ”¯æŒ **EVM å…¼å®¹é“¾**ï¼ˆä»¥ä»¥å¤ªåŠæµ‹è¯•ç½‘ Sepolia ä¸ºä¾‹ï¼›ä¹Ÿå¯æ¢æˆ BSC/Polygon/æœ¬åœ°ç§é“¾ï¼Œåªè¦æ˜¯ JSON-RPCï¼‰ã€‚

### 1) éƒ¨ç½²åˆçº¦ï¼ˆä¸€æ¬¡æ€§ï¼‰

åˆçº¦éœ€è¦æä¾› `anchor(string batchNo, bytes32 dataHash)` æ–¹æ³•ã€‚ä½ å¯ä»¥ç”¨ Remix éƒ¨ç½²ä¸‹é¢è¿™ä¸ªæœ€å°åˆçº¦ï¼š

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract TraceAnchor {
    event Anchored(string batchNo, bytes32 dataHash, address indexed sender, uint256 timestamp);
    mapping(string => bytes32) public hashes;

    function anchor(string calldata batchNo, bytes32 dataHash) external {
        hashes[batchNo] = dataHash;
        emit Anchored(batchNo, dataHash, msg.sender, block.timestamp);
    }
}
```

éƒ¨ç½²å®Œæˆåè®°å½•åˆçº¦åœ°å€ï¼š`EVM_CONTRACT_ADDRESS`ã€‚

### 2) é…ç½®åç«¯ï¼ˆç¯å¢ƒå˜é‡ï¼‰

åœ¨å¯åŠ¨åç«¯å‰è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¸è¦æŠŠç§é’¥æäº¤åˆ° gitï¼‰ï¼š

```bash
export APP_BLOCKCHAIN_MODE=EVM
export EVM_RPC_URL="https://sepolia.infura.io/v3/xxx"   # ä¹Ÿå¯ä»¥æ˜¯ä½ è‡ªå»ºèŠ‚ç‚¹çš„ http(s) rpc
export EVM_CHAIN_ID=11155111
export EVM_PRIVATE_KEY="0x..."                          # éƒ¨ç½²/ç­¾åç”¨è´¦æˆ·ç§é’¥ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
export EVM_CONTRACT_ADDRESS="0x..."                     # ä¸Šä¸€æ­¥éƒ¨ç½²çš„åˆçº¦åœ°å€
export EVM_EXPLORER_TX_URL="https://sepolia.etherscan.io/tx/"
```

ç„¶åå¯åŠ¨åç«¯å³å¯ã€‚

### 3) å°ç¨‹åºæ¼”ç¤ºå…¥å£

å°ç¨‹åºçš„â€œé˜²ä¼ª&åŒºå—é“¾â€é¡µé¢å¯ä»¥ï¼š
- `è®°å½•ä¸Šé“¾`ï¼šè°ƒç”¨ `POST /api/v1/blockchain/record`ï¼Œè¿”å› `txHash/txUrl/dataHash`
- `æŸ¥è¯¢ä¸Šé“¾`ï¼šè°ƒç”¨ `GET /api/v1/blockchain/{batchNo}`ï¼ŒæŸ¥çœ‹æ•°æ®åº“é‡Œä¿å­˜çš„ä¸Šé“¾ä¿¡æ¯

---
*æœ¬é¡¹ç›®ç”± Antigravity AI åä½œå¼€å‘ï¼Œè‡´åŠ›äºä¸­è¯æäº§ä¸šæ•°å­—åŒ–è½¬å‹ã€‚*
